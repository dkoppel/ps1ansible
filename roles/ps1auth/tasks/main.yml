---

- name: Add Root SSH Keys
  authorized_key: user=root key={{ item }}
  with_items: #TODO add the keys from saltstack and make this it's own task/role
     - http://github.com/hef.keys
     - http://github.com/dkoppel.keys
     - http://github.com/loansindi.keys
     - http://github.com/bjonnh.keys
     - http://github.com/codersquid.keys

- name: Install Dependencies
  pacman: name={{ item }} state=latest update_cache=yes
  with_items:
     - python
     - postgresql
     - python2-psycopg2
     - redis
     - git

- name: Create ps1auth User
  user: name=ps1auth state=present

- name: Clone github repository
  git: repo=https://github.com/hef/ps1auth dest={{ app_root }}/app

- name: Setup Python Environment
  pip: requirements={{ app_root }}/app/requirements/production.txt state=present virtualenv={{ app_root }}/venv

- name: Setup Bash Environment
  template: src=bashrc.j2 dest=/home/ps1auth/.bashrc

#- name: setup ps1auth.conf
#  copy: src=ps1auth.conf dest=/home/ps1auth/ps1auth.conf

#- name: configure django
#

# This doesn't work until you manually init the DB and start PostgreSQL
- name: Create PostgreSQL User
  sudo: postgres
  postgresql_user: name=ps1auth role_attr_flags=SUPERUSER state=present

- name: Create PostgreSQL DB
  sudo: postgres
  postgresql_db: name=ps1auth encoding=UTF-8 lc_collate=en_US.UTF-8 owner=ps1auth

#- name: celery??

#- name: configure systemd services

#- name: profit??
